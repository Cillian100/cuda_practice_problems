#include <cuda_runtime.h>
#include <stdio.h>
#include <math.h>
#include <bits/stdc++.h>
using namespace std;

__global__ void softmax_kernel_2(const float* input, float* output, int N, float* bottom){
    int work_id = threadIdx.x + blockDim.x * blockIdx.x;
    float top=0;
    if(work_id < N){
        if(isinf(exp(input[work_id]))){
            output[work_id]=1;
        }else{
            top=exp(input[work_id]);
            output[work_id]=top/bottom[0];    
        }
    }
}

__global__ void softmax_kernel_1(const float* input, float* output, int N) {
    int work_id = threadIdx.x + blockDim.x * blockIdx.x;
    if(work_id < N){
        if(isinf(output[0]) || isinf(exp(input[work_id]))){
            atomicAdd(&output[0], 100000000);
        }else{
            atomicAdd(&output[0], exp(input[work_id]));
        }
    }
}

// input, output are device pointers (i.e. pointers to memory on the GPU)
extern "C" void solve(const float* input, float* output, int N) {
    int threadsPerBlock = 256;
    int blocksPerGrid = (N + threadsPerBlock - 1) / threadsPerBlock;
    float* A = nullptr;
    cudaMalloc(&A, 1*sizeof(float));
    softmax_kernel_1<<<blocksPerGrid, threadsPerBlock>>>(input, A, N);
    cudaDeviceSynchronize();
    softmax_kernel_2<<<blocksPerGrid, threadsPerBlock>>>(input, output, N, A);
    cudaDeviceSynchronize();
}
